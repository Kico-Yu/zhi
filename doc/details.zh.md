## 手势支持的设计 ##

特性：支持触摸屏的tap、pan、flick等手势。
使用方式：库调用者设定需要手势支持的DOM元素作为捕捉手势的范围，同时设定所需要监听手势的种类；然后通过标准的addEventListener接口监听所需要的手势。

### 实现简介 ###

库内部实现为接口与调度程序、GestureDetector类和相关子类。

外部接口和调度主要是Zhi.detectGesture()方法。此方法接收手势范围和种类，并根据手势种类初始化相对应的GestureDetector。在所设定的DOM元素上监听touchstart、touchmove、touchend等事件，解析和保存每次触摸事件的每个触摸点的坐标数据，然后将事件和数据发送给每个GestureDectector。

GestureDetector为检测手势的基类，其子类包括检测tap（轻触）动作的TapDetector、检测pan（移动）动作的PanDetector、检测flick（快速滑动）动作的FlickDectector等。

TapDetector主要在touchend时检测，如果touchstart到touchend的时间在阈值内（200毫秒）并且touchend触摸坐标点与touchstart时的坐标点的距离也在阈值之内（16像素），则触发tap事件。如果是单指tap事件，为了减少系统所产生的click事件延迟（通常在300ms），会调用preventDefault()来阻止浏览器产生模拟鼠标事件，然后通过程序派发click事件。

Android浏览器无法通过调用touchend事件的preventDefault()阻止浏览器产生模拟鼠标事件，所以做了特别处理。如果是Android浏览器，则在window上监听捕捉阶段的鼠标事件。TapDetector会加入需要被忽略的系统模拟鼠标事件的特征数据，包括坐标和时间。前述事件监听器遍历待忽略的系统模拟鼠标事件队列，如果当前鼠标事件符合某个需要被忽略的系统模拟鼠标事件的特征，则调用preventDefault()和stopImmediatePropagation()阻止鼠标事件的默认行为和防止其他事件监听器被调用。

PanDetector用到Motion辅助类和Direction辅助类。Motion类表达从某个触摸事件到另一个触摸事件中相同触摸点的坐标变化，提供了对于移动距离、速度、角度、方向等的计算方法的抽象。Direction类根据极坐标角度计算方向值，计算方法如下：从0度到360度每15度为一个角度界限，共24个角度界限（0度和360度是重合的），将每个角度界限顺序分别对应1左移0到23的值，为该角度的方向值。如果两坐标点构成矢量的角度恰等于某个界限角度，则返回该界限所对应的方向值；如果角度落在某两个界限角度之间，则返回该两界限的方向值经过或位运算的结果。Direction类也提供了常见方向的方向值常量，如Direction[clock]（clock为1到12之间的数字）返回对应钟面指针的方向（如3点钟方向为正右方即0度所对应的方向值），Direction.UP返回正上方（90度）左右45度区域内所包含的角度界限的或运算值，DOWN、RIGHT、LEFT类同。Direction.ANY返回-1，表示任意方向。

detectGesture方法根据设定的手势种类创建PanDetector，如检测pan，则PanDetector的预设方向为Direction.ANY，如只检测pan-x（水平方向的移动动作），则预设方向为Direction.LEFT | Direction.RIGHT，如检测多个方向，则预设方向为多个方向的或位运算结果。PanDetector在touchmove时检测，由touchstart和第一次touchmove创建Motion对象。如果此Motion的方向值符合PanDetector预设的方向（与位运算结果不为0），则触发panstart事件。panstart事件的默认行为是调用当次touchmove事件的preventDefault()，这是为了阻止浏览器在检测方向上的默认行为，例如scrolling等。在Android浏览器中，如发生scrolling等默认行为，之后相关的触摸动作就不会再触发后续touchmove事件，故必须在第一个touchmove中处理。在panstart之后，若其未被cancel，则对于后续touchmove，PanDetector会触发pan事件；对于touchend，PanDetector会触发panend事件。

FlickDetector类在touchmove和touchend时检测，由 touchend或最后一次touchmove 与 上一次touchmove或touchstart 创建Motion对象。FlickDetector维护flick是否有效的状态。Android浏览器会在touchend之前产生一个位移为0的touchmove，故需要排除该种情况。所以若某次Motion的距离为0，则需检测Motion的时间是否超过预设阈值（100毫秒），如果超出则处于flick无效状态。其次若该Motion的速度大于预设的阈值（默认为0.5像素每毫秒）则处于flick有效状态，反之则处于flick无效状态。如果在touchend时处于flick有效状态，则触发flick事件。

为了性能优化考虑，以下常用的GestureDetector是被预先创建并复用的：没有自定义设置的TapDetector、没有自定义设置（即检测全方向）的PanDetector、检测水平方向的PanDetector、检测垂直方向的PanDetector、没有自定义设置的FlickDetector等。
